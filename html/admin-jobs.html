<!doctype html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>إدارة الوظائف - لوحة التحكم</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-[Cairo]">
	<header class="bg-white border-b">
		<div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
			<h1 class="text-xl font-bold">إدارة الوظائف</h1>
			<nav class="flex items-center gap-4 text-sm">
				<a href="admin-dashboard.html" class="text-blue-600 hover:underline">لوحة التحكم</a>
				<a href="admin-job-applications.html" class="text-blue-600 hover:underline">طلبات التقديم</a>
			</nav>
		</div>
	</header>

	<main class="max-w-7xl mx-auto px-4 py-6">
		<section class="bg-white border rounded-lg shadow-sm p-4">
			<h2 class="font-semibold mb-3">إضافة / تعديل وظيفة</h2>
			<form id="jobForm" class="grid md:grid-cols-3 gap-3">
				<input type="hidden" id="jobId" />
				<input id="jobName" type="text" placeholder="اسم الوظيفة" class="border rounded-md px-3 py-2" required />
				<label class="inline-flex items-center gap-2 text-sm">
					<input id="jobActive" type="checkbox" class="w-4 h-4" checked /> فعّال
				</label>
				<div class="md:col-span-3 flex gap-2">
					<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">حفظ</button>
					<button type="button" id="resetBtn" class="border px-4 py-2 rounded-md">إلغاء</button>
				</div>
			</form>
		</section>

		<section class="mt-6">
			<div class="flex items-center justify-between mb-3">
				<h2 class="font-semibold">جميع الوظائف</h2>
				<input id="searchInput" type="text" placeholder="بحث" class="border rounded-md px-3 py-2" />
			</div>
			<table class="w-full bg-white border rounded-lg shadow-sm text-sm">
				<thead>
					<tr class="border-b bg-gray-50">
						<th class="text-right p-3">#</th>
						<th class="text-right p-3">الاسم</th>
						<th class="text-right p-3">الحالة</th>
						<th class="text-right p-3">أضيفت</th>
						<th class="text-right p-3">إجراءات</th>
					</tr>
				</thead>
				<tbody id="jobsTable"></tbody>
			</table>
			<p id="emptyState" class="text-center text-gray-500 hidden mt-6">لا توجد وظائف</p>
		</section>
	</main>

	<script>
	const API_ORIGIN = localStorage.getItem('api_origin') || 'https://weenapp-001-site1.qtempurl.com';
	const API = {
		list: `${API_ORIGIN}/api/AdminJobs`,
		create: `${API_ORIGIN}/api/AdminJobs`,
		update: (id) => `${API_ORIGIN}/api/AdminJobs/${id}`,
		remove: (id) => `${API_ORIGIN}/api/AdminJobs/${id}`
	};

	function rowTemplate(j, idx){
		return `
			<tr class="border-b">
				<td class="p-3">${idx+1}</td>
				<td class="p-3">${j.name}</td>
				<td class="p-3">${j.isActive ? 'فعّال' : 'متوقف'}</td>
				<td class="p-3">${new Date(j.createdAt).toLocaleDateString()}</td>
				<td class="p-3">
					<button data-edit="${j.id}" class="text-blue-600 hover:underline mr-3">تعديل</button>
					<button data-del="${j.id}" class="text-red-600 hover:underline">حذف</button>
				</td>
			</tr>
		`;
	}

	async function fetchJobs(){
		const res = await fetch(API.list, { headers: authHeaders() });
		if(!res.ok) throw new Error('failed');
		return (await res.json()).data || [];
	}

	function authHeaders(){
		const token = localStorage.getItem('token');
		return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' };
	}

	async function saveJob(e){
		e.preventDefault();
		const id = document.getElementById('jobId').value;
		const payload = {
			name: document.getElementById('jobName').value.trim(),
			isActive: document.getElementById('jobActive').checked
		};
		const method = id ? 'PUT' : 'POST';
		const url = id ? API.update(id) : API.create;
		const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(payload) });
		if(!res.ok){ alert('فشل الحفظ'); return; }
		resetForm();
		render();
	}

	function resetForm(){
		document.getElementById('jobId').value = '';
		document.getElementById('jobName').value = '';
		document.getElementById('jobActive').checked = true;
	}

	function bindActions(){
		document.querySelectorAll('[data-edit]').forEach(btn => {
			btn.addEventListener('click', () => {
				const id = btn.getAttribute('data-edit');
				const row = cache.find(x => x.id == id);
				if(!row) return;
				document.getElementById('jobId').value = row.id;
				document.getElementById('jobName').value = row.name;
				document.getElementById('jobActive').checked = row.isActive;
				window.scrollTo({ top: 0, behavior: 'smooth' });
			});
		});
		document.querySelectorAll('[data-del]').forEach(btn => {
			btn.addEventListener('click', async () => {
				const id = btn.getAttribute('data-del');
				if(!confirm('تأكيد حذف الوظيفة؟')) return;
				const res = await fetch(API.remove(id), { method:'DELETE', headers: authHeaders() });
				if(!res.ok){ alert('فشل الحذف'); return; }
				render();
			});
		});
	}

	let cache = [];
	async function render(){
		const table = document.getElementById('jobsTable');
		const empty = document.getElementById('emptyState');
		const search = document.getElementById('searchInput').value.trim();
		table.innerHTML = '';
		try{
			cache = await fetchJobs();
			let data = cache;
			if(search) data = data.filter(x => x.name && x.name.includes(search));
			if(!data.length){ empty.classList.remove('hidden'); return; }
			empty.classList.add('hidden');
			table.innerHTML = data.map(rowTemplate).join('');
			bindActions();
		}catch(e){ empty.textContent = 'حدث خطأ أثناء الجلب'; empty.classList.remove('hidden'); }
	}

	document.getElementById('jobForm').addEventListener('submit', saveJob);
	document.getElementById('resetBtn').addEventListener('click', resetForm);
	document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') render(); });
	render();
	</script>
</body>
</html>
