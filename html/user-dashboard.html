<!doctype html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>لوحة المستخدم</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
	<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23111'/%3E%3Cpath fill='%23f59e0b' d='M22 10h4v20c0 6-4 8-4 8s-4-2-4-8V10h4zM38 10h4v14h6v4h-6v10h-4V10z'/%3E%3C/svg%3E">
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-[Cairo]">
	<header class="bg-gradient-to-r from-gray-900 to-black shadow-lg sticky top-0 z-40">
		<div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
			<div class="flex items-center space-x-3 space-x-reverse">
				<div class="w-10 h-10 bg-gradient-to-r from-yellow-600 to-amber-600 rounded-full flex items-center justify-center">
					<i class="fas fa-user text-white"></i>
				</div>
				<h1 class="text-white text-xl font-bold">لوحة المستخدم</h1>
			</div>
			<a href="../index.html" class="text-yellow-400 hover:text-white transition">الصفحة الرئيسية</a>
		</div>
	</header>

	<main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
		<!-- Hero / Welcome -->
		<section class="relative overflow-hidden rounded-2xl shadow-lg">
			<div class="absolute inset-0 bg-gradient-to-br from-amber-500 via-yellow-600 to-amber-700 opacity-90"></div>
			<div class="relative z-10 p-6 md:p-10 text-white">
				<h2 id="greeting" class="text-2xl md:text-3xl font-bold">مرحباً</h2>
				<p class="mt-2 text-white/90 max-w-2xl">من هنا يمكنك إدارة طلبات التقديم واستعراض الوظائف المتاحة بسهولة وبواجهة احترافية.</p>
				<div class="mt-5 flex flex-wrap gap-3">
					<a href="user-job-applications.html" class="bg-white text-gray-900 px-5 py-2.5 rounded-full font-semibold shadow hover:shadow-md transition">إدارة طلباتي</a>
					<a href="jobs.html" class="bg-black/20 backdrop-blur px-5 py-2.5 rounded-full font-semibold hover:bg-black/30 transition">تصفح الوظائف</a>
				</div>
			</div>
		</section>

		<!-- Stats -->
		<section>
			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
				<div class="bg-white border rounded-xl p-5 shadow-sm">
					<div class="flex items-center justify-between">
						<span class="text-sm text-gray-500">إجمالي الطلبات</span>
						<i class="fas fa-file-alt text-yellow-600"></i>
					</div>
					<div id="statTotal" class="mt-2 text-2xl font-bold">—</div>
				</div>
				<div class="bg-white border rounded-xl p-5 shadow-sm">
					<div class="flex items-center justify-between">
						<span class="text-sm text-gray-500">طلبات هذا الشهر</span>
						<i class="fas fa-calendar-alt text-emerald-600"></i>
					</div>
					<div id="statThisMonth" class="mt-2 text-2xl font-bold">—</div>
				</div>
				<div class="bg-white border rounded-xl p-5 shadow-sm">
					<div class="flex items-center justify-between">
						<span class="text-sm text-gray-500">آخر تحديث</span>
						<i class="fas fa-clock text-sky-600"></i>
					</div>
					<div id="statLastUpdated" class="mt-2 text-lg font-semibold">—</div>
				</div>
				<div class="bg-white border rounded-xl p-5 shadow-sm">
					<div class="flex items-center justify-between">
						<span class="text-sm text-gray-500">وظائف متاحة</span>
						<i class="fas fa-briefcase text-indigo-600"></i>
					</div>
					<div id="statJobs" class="mt-2 text-2xl font-bold">—</div>
				</div>
			</div>
		</section>

		<!-- Quick Links & Profile -->
		<section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
			<div class="lg:col-span-2 space-y-6">
				<!-- Recent Applications -->
				<div class="bg-white border rounded-xl shadow-sm">
					<div class="p-5 border-b">
						<h3 class="text-lg font-semibold">أحدث طلبات التقديم</h3>
					</div>
					<div class="p-5">
						<ul id="recentApps" class="divide-y"></ul>
						<p id="noApps" class="text-gray-500 text-sm">لا توجد طلبات حتى الآن.</p>
						<div class="mt-4">
							<a href="user-job-applications.html" class="text-blue-600 hover:underline text-sm">عرض كل الطلبات</a>
						</div>
					</div>
				</div>
			</div>
			<div class="space-y-6">
				<!-- Quick Actions -->
				<div class="bg-white border rounded-xl shadow-sm p-5">
					<h3 class="text-lg font-semibold mb-4">اختصارات سريعة</h3>
					<div class="grid grid-cols-2 gap-3">
						<a href="jobs.html" class="flex items-center justify-center gap-2 p-3 rounded-lg bg-gradient-to-br from-amber-50 to-yellow-50 hover:from-amber-100 hover:to-yellow-100 border transition">
							<i class="fas fa-briefcase text-yellow-700"></i>
							<span class="text-sm font-semibold text-gray-800">تصفح الوظائف</span>
						</a>
						<a href="user-job-applications.html" class="flex items-center justify-center gap-2 p-3 rounded-lg bg-gradient-to-br from-sky-50 to-cyan-50 hover:from-sky-100 hover:to-cyan-100 border transition">
							<i class="fas fa-file-signature text-sky-700"></i>
							<span class="text-sm font-semibold text-gray-800">إدارة طلباتي</span>
						</a>
					</div>
				</div>

				<!-- Profile Settings -->
				<div class="bg-white border rounded-xl shadow-sm p-5">
					<h3 class="text-lg font-semibold mb-4">الملف الشخصي</h3>
					<form id="profileForm" class="grid grid-cols-1 gap-4">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
							<div>
								<label class="block text-sm text-gray-600 mb-1">الاسم الأول</label>
								<input id="profileFirstName" type="text" class="w-full border rounded-lg px-3 py-2" required />
							</div>
							<div>
								<label class="block text-sm text-gray-600 mb-1">الاسم الأخير</label>
								<input id="profileLastName" type="text" class="w-full border rounded-lg px-3 py-2" required />
							</div>
							<div>
								<label class="block text-sm text-gray-600 mb-1">البريد الإلكتروني</label>
								<input id="profileEmail" type="email" class="w-full border rounded-lg px-3 py-2" required />
							</div>
							<div>
								<label class="block text-sm text-gray-600 mb-1">رقم الهاتف</label>
								<input id="profilePhone" type="tel" class="w-full border rounded-lg px-3 py-2" />
							</div>
							<div class="md:col-span-2">
								<label class="block text-sm text-gray-600 mb-1">المدينة</label>
								<input id="profileCity" type="text" class="w-full border rounded-lg px-3 py-2" />
							</div>
						</div>
						<div class="flex gap-2">
							<button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg">حفظ التعديلات</button>
						</div>
					</form>
				</div>

				<!-- Change Password -->
				<div class="bg-white border rounded-xl shadow-sm p-5">
					<h3 class="text-lg font-semibold mb-4">تغيير كلمة المرور</h3>
					<form id="passwordForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label class="block text-sm text-gray-600 mb-1">كلمة المرور الحالية</label>
							<input id="currentPassword" type="password" class="w-full border rounded-lg px-3 py-2" required />
						</div>
						<div>
							<label class="block text-sm text-gray-600 mb-1">كلمة المرور الجديدة</label>
							<input id="newPassword" type="password" class="w-full border rounded-lg px-3 py-2" required />
						</div>
						<div class="md:col-span-2">
							<button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg">تغيير كلمة المرور</button>
						</div>
					</form>
				</div>
			</div>
		</section>
	</main>

	<!-- Toast (reusable) -->
	<div id="toast" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-2xl border p-4 hidden z-50 max-w-sm">
		<div class="flex items-center space-x-3 space-x-reverse">
			<div id="toastIcon" class="flex-shrink-0"></div>
			<p id="toastMessage" class="text-sm font-semibold text-gray-800"></p>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
	<script>
	const API_ORIGIN = localStorage.getItem('api_origin') || 'https://weenapp-001-site1.qtempurl.com';
	const API = {
		jobs: `${API_ORIGIN}/api/Public/jobs`,
		myApps: `${API_ORIGIN}/api/UserJobApplications`,
		profile: `${API_ORIGIN}/api/AdminDashboard/profile`,
		changePassword: `${API_ORIGIN}/api/AdminDashboard/profile/change-password`
	};

	function parseJwt (token) {
		try{
			const base64Url = token.split('.')[1];
			const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
			const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
				return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
			}).join(''));
			return JSON.parse(jsonPayload);
		}catch{ return null; }
	}

	function authHeaders(){
		const token = localStorage.getItem('token');
		return token ? { 'Authorization': `Bearer ${token}` } : {};
	}

	function showToast(message, type='info'){
		const toast = document.getElementById('toast');
		const icon = document.getElementById('toastIcon');
		const msg = document.getElementById('toastMessage');
		msg.textContent = message;
		icon.innerHTML = type==='success' ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : type==='error' ? '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>' : '<i class="fas fa-info-circle text-blue-500 text-xl"></i>';
		toast.classList.remove('hidden');
		setTimeout(()=> toast.classList.add('hidden'), 2500);
	}

	function appListItem(a){
		return `
			<li class="py-3 first:pt-0 last:pb-0">
				<div class="flex items-start justify-between gap-3">
					<div>
						<div class="font-semibold text-gray-800">${a.jobName}</div>
						<div class="text-sm text-gray-600 mt-0.5">${a.city ?? '—'} • خبرة: ${a.yearsOfExperience ?? '—'}</div>
						${a.summary ? `<p class=\"text-sm text-gray-700 mt-1\">${a.summary}</p>` : ''}
					</div>
					<div class="text-xs text-gray-500">${new Date(a.createdAt).toLocaleDateString()}</div>
				</div>
			</li>
		`;
	}

	async function loadData(){
		// User info
		const token = localStorage.getItem('token');
		const claims = token ? parseJwt(token) : null;
		const firstName = claims?.FirstName || '';
		const lastName = claims?.LastName || '';
		const email = claims?.email || claims?.Email || '';
		const role = (claims && (claims['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] || claims['role'])) || 'user';

		document.getElementById('greeting').textContent = firstName || lastName ? `مرحباً ${firstName} ${lastName}` : 'مرحباً';

		try{
			// Stats jobs
			const jobsRes = await fetch(API.jobs);
			const jobs = jobsRes.ok ? ((await jobsRes.json()).data || []) : [];
			document.getElementById('statJobs').textContent = jobs.length;

			// My applications
			const appsRes = await fetch(API.myApps, { headers: authHeaders() });
			let apps = appsRes.ok ? ((await appsRes.json()).data || []) : [];
			document.getElementById('statTotal').textContent = apps.length;
			const thisMonth = apps.filter(a => new Date(a.createdAt).getMonth() === new Date().getMonth() && new Date(a.createdAt).getFullYear() === new Date().getFullYear());
			document.getElementById('statThisMonth').textContent = thisMonth.length;
			document.getElementById('statLastUpdated').textContent = apps[0] ? new Date(apps[0].updatedAt || apps[0].createdAt).toLocaleDateString() : '—';

			// Load profile fields
			const profRes = await fetch(API.profile, { headers: authHeaders() });
			if (profRes.ok) {
				const prof = await profRes.json();
				if (prof.success && prof.data) {
					document.getElementById('profileFirstName').value = prof.data.firstName || '';
					document.getElementById('profileLastName').value = prof.data.lastName || '';
					document.getElementById('profileEmail').value = prof.data.email || '';
					document.getElementById('profilePhone').value = prof.data.phoneNumber || '';
					document.getElementById('profileCity').value = prof.data.city || '';
				}
			}

			// Recent list
			apps = apps.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).slice(0,5);
			const list = document.getElementById('recentApps');
			const empty = document.getElementById('noApps');
			if(!apps.length){ empty.classList.remove('hidden'); list.innerHTML=''; }
			else { empty.classList.add('hidden'); list.innerHTML = apps.map(appListItem).join(''); }
		}catch(err){
			showToast('تعذر تحميل البيانات', 'error');
		}
	}

	// Submit handlers
	document.addEventListener('submit', async (e) => {
		if (e.target && e.target.id === 'profileForm') {
			e.preventDefault();
			const body = {
				firstName: document.getElementById('profileFirstName').value,
				lastName: document.getElementById('profileLastName').value,
				email: document.getElementById('profileEmail').value,
				phoneNumber: document.getElementById('profilePhone').value,
				city: document.getElementById('profileCity').value
			};
			const res = await fetch(API.profile, { method:'PUT', headers: { ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify(body) });
			const json = await res.json();
			if (json.success) showToast('تم حفظ التعديلات','success'); else showToast(json.message||'فشل الحفظ','error');
		}
		if (e.target && e.target.id === 'passwordForm') {
			e.preventDefault();
			const body = {
				currentPassword: document.getElementById('currentPassword').value,
				newPassword: document.getElementById('newPassword').value
			};
			const res = await fetch(API.changePassword, { method:'POST', headers: { ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify(body) });
			const json = await res.json();
			if (json.success) showToast('تم تغيير كلمة المرور','success'); else showToast(json.message||'فشل تغيير الكلمة','error');
		}
	});

	loadData();
	</script>
</body>
</html>
